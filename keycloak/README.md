# Keycloak Kubernetes Deployment Manual
We are deploying [Keycloak](https://www.keycloak.org/) on our Rancher cluster using the [bitnami/keycloak](https://bitnami.com/stack/keycloak/helm) Helm chart.

Prerequisites:
 - Have a storage class `rook-ceph-block` configured.

The following settings for the Helm chart are used:
```yaml
---
affinity: {}
args: []
auth:
  adminPassword: ''
  adminUser: user
  createAdminUser: true
  existingSecret: ''
  existingSecretPerPassword: {}
  managementPassword: ''
  managementUser: manager
  tls:
    autoGenerated: false
    enabled: false
    existingSecret: ''
    jksSecret: ''
    keystoreFilename: ''
    keystorePassword: ''
    resources:
      limits: {}
      requests: {}
    truststoreFilename: ''
    truststorePassword: ''
autoscaling:
  enabled: false
  maxReplicas: 11
  minReplicas: 1
  targetCPU: ''
  targetMemory: ''
cache:
  authOwnersCount: 1
  ownersCount: 1
clusterDomain: cluster.local
command: []
commonAnnotations: {}
commonLabels: {}
configuration: ''
containerPorts:
  http: 8080
  https: 8443
containerSecurityContext:
  enabled: true
  runAsNonRoot: true
  runAsUser: 1001
customLivenessProbe: {}
customReadinessProbe: {}
customStartupProbe: {}
existingConfigmap: ''
externalDatabase:
  database: bitnami_keycloak
  existingSecret: ''
  host: ''
  password: ''
  port: 5432
  user: bn_keycloak
extraDeploy: []
extraEnvVars: []
extraEnvVarsCM: ''
extraEnvVarsSecret: ''
extraStartupArgs: ''
extraVolumeMounts:
  - mountPath: /opt/bitnami/keycloak/themes/podkrepi
    name: theme
extraVolumes:
  - emptyDir: {}
    name: theme
fullnameOverride: ''
global:
  imagePullSecrets: []
  imageRegistry: ''
  storageClass: 'rook-ceph-block'
hostAliases: []
image:
  debug: false
  pullPolicy: IfNotPresent
  pullSecrets: []
  registry: docker.io
  repository: bitnami/keycloak
  tag: 15.1.0-debian-10-r0
ingress:
  annotations:
    ingress.kubernetes.io/affinity: cookie
    nginx.ingress.kubernetes.io/proxy-buffer-size: 256k
  apiVersion: ''
  enabled: true
  existingSecret: ''
  extraHosts: []
  extraTls: []
  hostname: keycloak.podkrepi.bg
  ingressClassName: ''
  path: /
  pathType: ImplementationSpecific
  secrets: []
  servicePort: http
  tls: true
initContainers:
  - name: download-theme
    image: bitnami/git:2.34.1
    imagePullPolicy: IfNotPresent
    args:
      - '-c'
      - |
        git clone https://github.com/podkrepi-bg/infrastructure /tmp
        cp -R /tmp/keycloak/theme_podkrepi/. /theme
    command:
      - sh
    volumeMounts:
      - mountPath: /theme
        name: theme
initdbScripts: {}
initdbScriptsConfigMap: ''
keycloakConfigCli:
  annotations:
    helm.sh/hook: post-install,post-upgrade,post-rollback
    helm.sh/hook-delete-policy: hook-succeeded,before-hook-creation
    helm.sh/hook-weight: '5'
  args: []
  backoffLimit: 1
  command: []
  configuration: {}
  containerSecurityContext:
    enabled: true
    runAsNonRoot: true
    runAsUser: 1001
  enabled: false
  existingConfigmap: ''
  extraEnvVars: []
  extraEnvVarsCM: ''
  extraEnvVarsSecret: ''
  extraVolumeMounts: []
  extraVolumes: []
  hostAliases: []
  image:
    pullPolicy: IfNotPresent
    pullSecrets: []
    registry: docker.io
    repository: bitnami/keycloak-config-cli
    tag: 4.4.0-debian-10-r4
  podAnnotations: {}
  podLabels: {}
  podSecurityContext:
    enabled: true
    fsGroup: 1001
  resources:
    limits: {}
    requests: {}
kubeVersion: ''
lifecycleHooks: {}
livenessProbe:
  enabled: true
  failureThreshold: 3
  httpGet:
    path: /auth/
    port: http
  initialDelaySeconds: 300
  periodSeconds: 1
  successThreshold: 1
  timeoutSeconds: 5
metrics:
  enabled: false
  service:
    annotations:
      prometheus.io/port: '{{ .Values.metrics.service.port }}'
      prometheus.io/scrape: 'true'
    port: 9990
  serviceMonitor:
    additionalLabels: {}
    enabled: false
    honorLabels: false
    interval: 30s
    namespace: ''
    relabellings: []
    scrapeTimeout: ''
nameOverride: ''
networkPolicy:
  additionalRules: {}
  allowExternal: true
  enabled: false
nodeAffinityPreset:
  key: ''
  type: ''
  values: []
nodeSelector: {}
pdb:
  create: false
  maxUnavailable: ''
  minAvailable: 1
podAffinityPreset: ''
podAnnotations: {}
podAntiAffinityPreset: soft
podLabels: {}
podSecurityContext:
  enabled: true
  fsGroup: 1001
postgresql:
  enabled: true
  existingSecret: ''
  persistence:
    enabled: true
  postgresqlDatabase: bitnami_keycloak
  postgresqlPassword: ''
  postgresqlUsername: bn_keycloak
priorityClassName: ''
proxyAddressForwarding: true
rbac:
  create: false
  rules: []
readinessProbe:
  enabled: true
  failureThreshold: 3
  httpGet:
    path: /auth/realms/master
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  successThreshold: 1
  timeoutSeconds: 1
replicaCount: 1
resources:
  limits: {}
  requests: {}
service:
  annotations: {}
  clusterIP: ''
  externalTrafficPolicy: Cluster
  httpsPort: 443
  loadBalancerIP: ''
  loadBalancerSourceRanges: []
  nodePorts:
    http: ''
    https: ''
  port: 80
  type: ClusterIP
serviceAccount:
  automountServiceAccountToken: false
  create: true
  name: ''
serviceDiscovery:
  enabled: false
  properties: []
  protocol: kubernetes.KUBE_PING
  transportStack: tcp
sidecars: []
startupProbe:
  enabled: false
  failureThreshold: 60
  httpGet:
    path: /auth/
    port: http
  initialDelaySeconds: 30
  periodSeconds: 5
  successThreshold: 1
  timeoutSeconds: 1
tolerations: []
updateStrategy:
  type: RollingUpdate

```

## Pulling a new version of the custom theme
To pull a newer version of the custom theme from the current repo just delete the Keycloak pod from the cluster. A new one will be automatically created and the latest version of the theme will be available there.

# Local keycloak for development
Run docker-compose up with the docker-compose.yml from this folder. The server will start on localhost:9080 with default admin user: user and default password: bitnami as per default configuration from here: https://hub.docker.com/r/bitnami/keycloak/

Then you need to create the webapp-dev realm and redirect the frontend and api to it. More details on configuring the realm here: https://www.keycloak.org/docs/latest/server_admin/#configuring-realms

# Custom Theme for Podkrepi.bg
The docker-compose.yml will also add a custom theme with the style of Podkprepi.bg from ./theme-podkrepi . 
To make more changes in see tutorial here: https://www.keycloak.org/docs/latest/server_development/#creating-a-theme

